
local playersService = game:GetService("Players")
local workspaceService = game:GetService("Workspace")
local runService = game:GetService("RunService")
local userInputService = game:GetService("UserInputService")
local tweenService = game:GetService("TweenService")

local espModule = {}
espModule.__index = espModule

espModule.Config = {
    TeamCheck = true,
    ESPDistance = 1000,
    BoxColor = Color3.new(0.403922, 0.34902, 0.701961),
    BoxGradientEnabled = false,
    BoxGradientColor1 = Color3.new(0.403922, 0.34902, 0.701961),
    BoxGradientColor2 = Color3.new(0.8, 0.4, 1),
    BoxFillTransparency = 0.5,
    RotateSpeed = 120,
    BoxOutlineEnabled = true,
    BoxOutlineColor = Color3.new(0, 0, 0),
    SkeletonColor = Color3.new(0.403922, 0.34902, 0.701961),
    ChamsColor = Color3.new(0.403922, 0.34902, 0.701961),
    TracerOrigin = "Bottom Screen",
    TracerColor = Color3.new(0.403922, 0.34902, 0.701961),
    ChamsFillTransparency = 0.5,
    ChamsOutlineColor = Color3.new(1, 1, 1),
    HealthBarLerpSpeed = 0.2,
    HealthBarColor1 = Color3.fromRGB(0, 255, 0),
    HealthBarColor2 = Color3.fromRGB(255, 255, 0),
    HealthBarColor3 = Color3.fromRGB(255, 0, 0),
    ArmorBarColor1 = Color3.fromRGB(0, 0, 255),
    ArmorBarColor2 = Color3.fromRGB(135, 206, 235),
    ArmorBarColor3 = Color3.fromRGB(1, 0, 0),
    RingColor = Color3.fromRGB(255, 255, 255),
    ScanSpeed = 2.5,
    ScanHeight = 3.5,
    RingRadius = 2.5
}

espModule.State = {
    BoxEnabled = false,
    NameEnabled = false,
    DistanceEnabled = false,
    SkeletonEnabled = false,
    HealthTextEnabled = false,
    HealthBarEnabled = false,
    ArmorBarEnabled = false,
    TracerEnabled = false,
    ChamsEnabled = false,
    RingEnabled = false
}

espModule.Caches = {
    BoxCache = {},
    SkeletonCache = {},
    TracerCache = {},
    ChamsCache = {},
    RingCache = {}
}

local localPlayer = playersService.LocalPlayer
local currentCamera = workspaceService.CurrentCamera
local updateInterval = 30
local heartbeatConnection = nil
local renderConnection = nil
local currentRotation = 0

local function safeCall(callback)
    local success, errorMessage = pcall(callback)
    if not success then
        warn("MatchaEsp Error: " .. tostring(errorMessage))
    end
end

local function lerpNumber(a, b, t)
    return a + (b - a) * t
end

local function getGradientColor(color1, color2, percentage)
    return Color3.new(
        lerpNumber(color1.R, color2.R, percentage),
        lerpNumber(color1.G, color2.G, percentage),
        lerpNumber(color1.B, color2.B, percentage)
    )
end

local function getCameraDistance(worldPosition)
    return (currentCamera.CFrame.Position - worldPosition).Magnitude
end

function espModule:CreateBox(_)
    local boxDrawings = {
        Box = Drawing.new("Square"),
        BoxOutline = Drawing.new("Square"),
        BoxTop = Drawing.new("Line"),
        BoxBottom = Drawing.new("Line"),
        BoxLeft = Drawing.new("Line"),
        BoxRight = Drawing.new("Line"),
        Name = Drawing.new("Text"),
        Distance = Drawing.new("Text"),
        HealthText = Instance.new("TextLabel"),
        HealthBarBackground = Instance.new("Frame"),
        HealthBarOutline = Instance.new("UIStroke"),
        HealthBar = Instance.new("Frame"),
        HealthBarGradient = Instance.new("UIGradient"),
        ArmorText = Instance.new("TextLabel"),
        ArmorBarBackground = Instance.new("Frame"),
        ArmorBarOutline = Instance.new("UIStroke"),
        ArmorBar = Instance.new("Frame"),
        ArmorBarGradient = Instance.new("UIGradient"),
        CurrentHealth = 100,
        TargetHealth = 100,
        CurrentArmor = 130,
        TargetArmor = 130,
        FillFrame = Instance.new("Frame"),
        Gradient = Instance.new("UIGradient"),
        Stroke = Instance.new("UIStroke")
    }
    
    -- Parent UI elements
    boxDrawings.HealthText.Parent = self.EspGui
    boxDrawings.HealthBarBackground.Parent = self.EspGui
    boxDrawings.HealthBar.Parent = self.EspGui
    boxDrawings.ArmorText.Parent = self.EspGui
    boxDrawings.ArmorBarBackground.Parent = self.EspGui
    boxDrawings.ArmorBar.Parent = self.EspGui
    boxDrawings.FillFrame.Parent = self.EspGui
    
    boxDrawings.FillFrame.BorderSizePixel = 0
    boxDrawings.FillFrame.BackgroundTransparency = 1
    boxDrawings.FillFrame.Visible = false
    boxDrawings.Gradient.Parent = boxDrawings.FillFrame
    boxDrawings.Gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, self.Config.BoxGradientColor1),
        ColorSequenceKeypoint.new(0.5, self.Config.BoxGradientColor2),
        ColorSequenceKeypoint.new(1, self.Config.BoxGradientColor1)
    })
    boxDrawings.Stroke.Parent = boxDrawings.FillFrame
    boxDrawings.Stroke.Thickness = 1.2
    boxDrawings.Stroke.Color = self.Config.BoxOutlineColor
    boxDrawings.Stroke.Transparency = 0
    boxDrawings.Stroke.Enabled = self.Config.BoxOutlineEnabled
    
    -- Main box
    boxDrawings.Box.Thickness = 1
    boxDrawings.Box.Color = self.Config.BoxColor
    boxDrawings.Box.Filled = false
    boxDrawings.Box.Visible = false
    
    -- Box outline
    boxDrawings.BoxOutline.Thickness = 3
    boxDrawings.BoxOutline.Color = self.Config.BoxOutlineColor
    boxDrawings.BoxOutline.Filled = false
    boxDrawings.BoxOutline.Visible = false
    boxDrawings.BoxOutline.Transparency = 0
    
    -- Gradient lines
    boxDrawings.BoxTop.Thickness = 1
    boxDrawings.BoxTop.Visible = false
    boxDrawings.BoxBottom.Thickness = 1
    boxDrawings.BoxBottom.Visible = false
    boxDrawings.BoxLeft.Thickness = 1
    boxDrawings.BoxLeft.Visible = false
    boxDrawings.BoxRight.Thickness = 1
    boxDrawings.BoxRight.Visible = false
    
    -- Text elements
    boxDrawings.Name.Size = 13
    boxDrawings.Name.Color = Color3.new(1, 1, 1)
    boxDrawings.Name.Outline = true
    boxDrawings.Name.Center = true
    boxDrawings.Name.Visible = false
    boxDrawings.Name.Font = 2
    
    boxDrawings.Distance.Size = 13
    boxDrawings.Distance.Color = Color3.new(1, 1, 1)
    boxDrawings.Distance.Outline = true
    boxDrawings.Distance.Center = true
    boxDrawings.Distance.Visible = false
    boxDrawings.Distance.Font = 2
    
    -- Health text
    boxDrawings.HealthText.BackgroundTransparency = 1
    boxDrawings.HealthText.TextSize = 12
    boxDrawings.HealthText.Font = Enum.Font.Code
    boxDrawings.HealthText.TextXAlignment = Enum.TextXAlignment.Left
    boxDrawings.HealthText.TextYAlignment = Enum.TextYAlignment.Center
    boxDrawings.HealthText.Visible = false
    boxDrawings.HealthText.TextStrokeTransparency = 0
    boxDrawings.HealthText.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    
    -- Armor text
    boxDrawings.ArmorText.BackgroundTransparency = 1
    boxDrawings.ArmorText.TextSize = 12
    boxDrawings.ArmorText.Font = Enum.Font.Code
    boxDrawings.ArmorText.TextXAlignment = Enum.TextXAlignment.Left
    boxDrawings.ArmorText.TextYAlignment = Enum.TextYAlignment.Center
    boxDrawings.ArmorText.Visible = false
    boxDrawings.ArmorText.TextStrokeTransparency = 0
    boxDrawings.ArmorText.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    
    -- Health bar background
    boxDrawings.HealthBarBackground.BackgroundColor3 = Color3.fromRGB(21, 21, 21)
    boxDrawings.HealthBarBackground.BackgroundTransparency = 0.45
    boxDrawings.HealthBarBackground.BorderSizePixel = 0
    boxDrawings.HealthBarBackground.Visible = false
    
    boxDrawings.HealthBarOutline.Parent = boxDrawings.HealthBarBackground
    boxDrawings.HealthBarOutline.Color = Color3.fromRGB(0, 0, 0)
    boxDrawings.HealthBarOutline.Transparency = 0.2
    boxDrawings.HealthBarOutline.Thickness = 1
    boxDrawings.HealthBarOutline.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    
    -- Health bar
    boxDrawings.HealthBar.BackgroundTransparency = 0
    boxDrawings.HealthBar.BorderSizePixel = 0
    boxDrawings.HealthBar.Visible = false
    
    boxDrawings.HealthBarGradient.Parent = boxDrawings.HealthBar
    boxDrawings.HealthBarGradient.Rotation = 90
    boxDrawings.HealthBarGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, self.Config.HealthBarColor1),
        ColorSequenceKeypoint.new(0.5, self.Config.HealthBarColor2),
        ColorSequenceKeypoint.new(1, self.Config.HealthBarColor3)
    })
    
    -- Armor bar background
    boxDrawings.ArmorBarBackground.BackgroundColor3 = Color3.fromRGB(21, 21, 21)
    boxDrawings.ArmorBarBackground.BackgroundTransparency = 0.45
    boxDrawings.ArmorBarBackground.BorderSizePixel = 0
    boxDrawings.ArmorBarBackground.Visible = false
    
    boxDrawings.ArmorBarOutline.Parent = boxDrawings.ArmorBarBackground
    boxDrawings.ArmorBarOutline.Color = Color3.fromRGB(0, 0, 0)
    boxDrawings.ArmorBarOutline.Transparency = 0.2
    boxDrawings.ArmorBarOutline.Thickness = 1
    boxDrawings.ArmorBarOutline.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    
    -- Armor bar
    boxDrawings.ArmorBar.BackgroundTransparency = 0
    boxDrawings.ArmorBar.BorderSizePixel = 0
    boxDrawings.ArmorBar.Visible = false
    
    boxDrawings.ArmorBarGradient.Parent = boxDrawings.ArmorBar
    boxDrawings.ArmorBarGradient.Rotation = 90
    boxDrawings.ArmorBarGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, self.Config.ArmorBarColor1),
        ColorSequenceKeypoint.new(0.5, self.Config.ArmorBarColor2),
        ColorSequenceKeypoint.new(1, self.Config.ArmorBarColor3)
    })
    
    return boxDrawings
end

function espModule:CreateSkeleton(targetPlayer)
    local targetCharacter = targetPlayer.Character
    local isR6 = targetCharacter and targetCharacter:FindFirstChild("Torso") and not targetCharacter:FindFirstChild("UpperTorso")
    
    local skeletonLines
    if isR6 then
        skeletonLines = {
            HeadToTorso = Drawing.new("Line"),
            TorsoToLeftArm = Drawing.new("Line"),
            TorsoToRightArm = Drawing.new("Line"),
            TorsoToLeftLeg = Drawing.new("Line"),
            TorsoToRightLeg = Drawing.new("Line")
        }
    else
        skeletonLines = {
            HeadToUpperTorso = Drawing.new("Line"),
            UpperTorsoToLowerTorso = Drawing.new("Line"),
            UpperTorsoToLeftUpperArm = Drawing.new("Line"),
            LeftUpperArmToLeftLowerArm = Drawing.new("Line"),
            LeftLowerArmToLeftHand = Drawing.new("Line"),
            UpperTorsoToRightUpperArm = Drawing.new("Line"),
            RightUpperArmToRightLowerArm = Drawing.new("Line"),
            RightLowerArmToRightHand = Drawing.new("Line"),
            LowerTorsoToLeftUpperLeg = Drawing.new("Line"),
            LeftUpperLegToLeftLowerLeg = Drawing.new("Line"),
            LeftLowerLegToLeftFoot = Drawing.new("Line"),
            LowerTorsoToRightUpperLeg = Drawing.new("Line"),
            RightUpperLegToRightLowerLeg = Drawing.new("Line"),
            RightLowerLegToRightFoot = Drawing.new("Line")
        }
    end
    
    for _, line in pairs(skeletonLines) do
        line.Thickness = 1.5
        line.Color = self.Config.SkeletonColor
        line.Visible = false
    end
    
    return skeletonLines
end

function espModule:CreateTracer(_)
    local tracerLine = Drawing.new("Line")
    tracerLine.Thickness = 1
    tracerLine.Color = self.Config.TracerColor
    tracerLine.Visible = false
    return tracerLine
end

function espModule:CreateChams(targetPlayer)
    local highlight = Instance.new("Highlight")
    highlight.FillColor = self.Config.ChamsColor
    highlight.OutlineColor = self.Config.ChamsOutlineColor
    highlight.FillTransparency = self.Config.ChamsFillTransparency
    highlight.OutlineTransparency = 0
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = targetPlayer.Character
    highlight.Adornee = targetPlayer.Character
    return highlight
end

function espModule:CreateRing(player)
    if player == localPlayer then return end
    local holder = Instance.new("Part")
    holder.Name = "ESP_Holder_" .. player.Name
    holder.Transparency = 1
    holder.CanCollide = false
    holder.Anchored = true
    holder.Parent = workspace
    local ring = Instance.new("CylinderHandleAdornment")
    ring.Adornee = holder
    ring.AlwaysOnTop = true
    ring.ZIndex = 10
    ring.Color3 = self.Config.RingColor
    ring.InnerRadius = self.Config.RingRadius - 0.1
    ring.Radius = self.Config.RingRadius
    ring.Height = 0.08
    ring.CFrame = CFrame.Angles(math.rad(90), 0, 0)
    ring.Parent = holder
    ring.Visible = false
    return {Holder = holder, Ring = ring, Root = nil}
end

function espModule:ClearBox(targetPlayer)
    if self.Caches.BoxCache[targetPlayer] then
        self.Caches.BoxCache[targetPlayer].Box:Remove()
        self.Caches.BoxCache[targetPlayer].BoxOutline:Remove()
        self.Caches.BoxCache[targetPlayer].BoxTop:Remove()
        self.Caches.BoxCache[targetPlayer].BoxBottom:Remove()
        self.Caches.BoxCache[targetPlayer].BoxLeft:Remove()
        self.Caches.BoxCache[targetPlayer].BoxRight:Remove()
        self.Caches.BoxCache[targetPlayer].Name:Remove()
        self.Caches.BoxCache[targetPlayer].Distance:Remove()
        self.Caches.BoxCache[targetPlayer].HealthText:Destroy()
        self.Caches.BoxCache[targetPlayer].HealthBarBackground:Destroy()
        self.Caches.BoxCache[targetPlayer].HealthBarOutline:Destroy()
        self.Caches.BoxCache[targetPlayer].HealthBar:Destroy()
        self.Caches.BoxCache[targetPlayer].FillFrame:Destroy()
        self.Caches.BoxCache[targetPlayer] = nil
    end
end

function espModule:ClearSkeleton(targetPlayer)
    if self.Caches.SkeletonCache[targetPlayer] then
        for _, line in pairs(self.Caches.SkeletonCache[targetPlayer]) do
            line:Remove()
        end
        self.Caches.SkeletonCache[targetPlayer] = nil
    end
end

function espModule:ClearTracer(targetPlayer)
    if self.Caches.TracerCache[targetPlayer] then
        self.Caches.TracerCache[targetPlayer]:Remove()
        self.Caches.TracerCache[targetPlayer] = nil
    end
end

function espModule:ClearChams(targetPlayer)
    if self.Caches.ChamsCache[targetPlayer] then
        self.Caches.ChamsCache[targetPlayer]:Destroy()
        self.Caches.ChamsCache[targetPlayer] = nil
    end
end

function espModule:ClearRing(targetPlayer)
    if self.Caches.RingCache[targetPlayer] then
        self.Caches.RingCache[targetPlayer].Holder:Destroy()
        self.Caches.RingCache[targetPlayer] = nil
    end
end

function espModule:HideBox(targetPlayer)
    if self.Caches.BoxCache[targetPlayer] then
        local boxDrawings = self.Caches.BoxCache[targetPlayer]
        boxDrawings.Box.Visible = false
        boxDrawings.BoxOutline.Visible = false
        boxDrawings.FillFrame.Visible = false
        boxDrawings.Name.Visible = false
        boxDrawings.Distance.Visible = false
        boxDrawings.HealthText.Visible = false
        boxDrawings.HealthBar.Visible = false
        boxDrawings.HealthBarBackground.Visible = false
        boxDrawings.HealthBarOutline.Visible = false
        boxDrawings.BoxTop.Visible = false
        boxDrawings.BoxBottom.Visible = false
        boxDrawings.BoxLeft.Visible = false
        boxDrawings.BoxRight.Visible = false
    end
end

function espModule:UpdateBox()
    -- Kiểm tra xem có tính năng nào đang bật không để tránh chạy vòng lặp vô ích
    if self.State.BoxEnabled or self.State.NameEnabled or self.State.DistanceEnabled or self.State.HealthTextEnabled or self.State.HealthBarEnabled or self.State.ArmorBarEnabled then
        
        if localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local cameraPos = currentCamera.CFrame.Position
            
            for _, otherPlayer in ipairs(playersService:GetPlayers()) do
                if otherPlayer ~= localPlayer then
                    local otherCharacter = otherPlayer.Character
                    
                    -- Kiểm tra Character hợp lệ
                    if otherCharacter and otherCharacter:FindFirstChild("HumanoidRootPart") and otherCharacter:FindFirstChild("Humanoid") then
                        local otherHumanoid = otherCharacter.Humanoid
                        local otherRoot = otherCharacter.HumanoidRootPart
                        
                        if otherHumanoid.Health > 0 then
                            local distance = getCameraDistance(otherRoot.Position)
                            
                            -- Kiểm tra khoảng cách hiển thị
                            if distance <= self.Config.ESPDistance then
                                
                                -- Kiểm tra Team (nếu bật)
                                if self.Config.TeamCheck and localPlayer.Team and otherPlayer.Team == localPlayer.Team then
                                    self:ClearBox(otherPlayer)
                                    goto continue_loop -- Dùng goto hoặc return tùy logic, ở đây dùng goto để skip qua player này
                                end

                                -- Tạo Box nếu chưa có trong Cache
                                if not self.Caches.BoxCache[otherPlayer] then
                                    self.Caches.BoxCache[otherPlayer] = self:CreateBox(otherPlayer)
                                end
                                
                                local boxDrawings = self.Caches.BoxCache[otherPlayer]
                                local rootScreenPos, rootOnScreen = currentCamera:WorldToViewportPoint(otherRoot.Position)
                                
                                if rootOnScreen then
                                    -- Tính toán kích thước Box
                                    local headPart = otherCharacter:FindFirstChild("Head")
                                    local headTopPos = headPart and headPart.Position + Vector3.new(0, 1, 0) or otherRoot.Position + Vector3.new(0, 3, 0)
                                    local feetPos = otherRoot.Position - Vector3.new(0, 3, 0)
                                    
                                    local headTopScreenPos = currentCamera:WorldToViewportPoint(headTopPos)
                                    local feetScreenPos = currentCamera:WorldToViewportPoint(feetPos)
                                    
                                    local height = math.abs(headTopScreenPos.Y - feetScreenPos.Y)
                                    local width = height * 0.66
                                    
                                    local centerPos = Vector2.new(rootScreenPos.X, (headTopScreenPos.Y + feetScreenPos.Y) / 2)
                                    local topLeft = centerPos - Vector2.new(width / 2, height / 2)
                                    local topRight = centerPos + Vector2.new(width / 2, -height / 2)
                                    local bottomLeft = centerPos + Vector2.new(-width / 2, height / 2)
                                    local bottomRight = centerPos + Vector2.new(width / 2, height / 2)

                                    -- Cập nhật Lerp Health
                                    boxDrawings.TargetHealth = otherHumanoid.Health / otherHumanoid.MaxHealth * 100
                                    boxDrawings.CurrentHealth = lerpNumber(boxDrawings.CurrentHealth, boxDrawings.TargetHealth, self.Config.HealthBarLerpSpeed)
                                    local healthPercentage = boxDrawings.CurrentHealth / 100 -- Sử dụng giá trị đã lerp

                                    -- 1. Xử lý vẽ Box (Khung)
                                    if self.State.BoxEnabled then
                                        if self.Config.BoxGradientEnabled then
                                            -- Logic Gradient (Ẩn các phần vẽ thông thường)
                                            boxDrawings.Box.Visible = false
                                            boxDrawings.BoxOutline.Visible = false
                                            boxDrawings.BoxTop.Visible = false
                                            boxDrawings.BoxBottom.Visible = false
                                            boxDrawings.BoxLeft.Visible = false
                                            boxDrawings.BoxRight.Visible = false
                                            
                                            boxDrawings.FillFrame.Position = UDim2.fromOffset(topLeft.X, topLeft.Y)
                                            boxDrawings.FillFrame.Size = UDim2.fromOffset(width, height)
                                            boxDrawings.FillFrame.BackgroundTransparency = self.Config.BoxFillTransparency
                                            boxDrawings.FillFrame.Visible = true
                                            
                                            boxDrawings.Stroke.Enabled = self.Config.BoxOutlineEnabled
                                            boxDrawings.Stroke.Color = self.Config.BoxOutlineColor
                                            boxDrawings.Stroke.Transparency = 0
                                        else
                                            -- Logic Box thường
                                            boxDrawings.FillFrame.Visible = false
                                            
                                            boxDrawings.Box.Size = Vector2.new(width, height)
                                            boxDrawings.Box.Position = topLeft
                                            boxDrawings.Box.Color = self.Config.BoxColor
                                            boxDrawings.Box.Visible = true
                                            
                                            if self.Config.BoxOutlineEnabled then
                                                boxDrawings.BoxOutline.Size = Vector2.new(width, height)
                                                boxDrawings.BoxOutline.Position = topLeft
                                                boxDrawings.BoxOutline.Color = self.Config.BoxOutlineColor
                                                boxDrawings.BoxOutline.Visible = true
                                                boxDrawings.BoxOutline.Transparency = 0
                                            else
                                                boxDrawings.BoxOutline.Visible = false
                                            end
                                        end
                                    else
                                        -- Tắt hiển thị Box
                                        boxDrawings.Box.Visible = false
                                        boxDrawings.BoxOutline.Visible = false
                                        boxDrawings.FillFrame.Visible = false
                                        boxDrawings.BoxTop.Visible = false
                                        boxDrawings.BoxBottom.Visible = false
                                        boxDrawings.BoxLeft.Visible = false
                                        boxDrawings.BoxRight.Visible = false
                                    end
                                    
                                    -- 2. Xử lý Tên (Name)
                                    if self.State.NameEnabled then
                                        boxDrawings.Name.Position = Vector2.new(centerPos.X, headTopScreenPos.Y - 20)
                                        boxDrawings.Name.Text = otherPlayer.Name
                                        boxDrawings.Name.Visible = true
                                    else
                                        boxDrawings.Name.Visible = false
                                    end
                                    
                                    -- 3. Xử lý Khoảng cách (Distance)
                                    if self.State.DistanceEnabled then
                                        boxDrawings.Distance.Position = Vector2.new(centerPos.X, feetScreenPos.Y + 5)
                                        boxDrawings.Distance.Text = math.floor(distance) .. " studs"
                                        boxDrawings.Distance.Visible = true
                                    else
                                        boxDrawings.Distance.Visible = false
                                    end

                                    -- Tọa độ chuẩn cho các thanh Bar bên trái
                                    local barX = topLeft.X - 6
                                    local barY = topLeft.Y
                                    
                                    -- 4. Xử lý Thanh Máu (Health Bar)
                                    if self.State.HealthBarEnabled or self.State.HealthTextEnabled then
                                        local health_per = math.floor(otherHumanoid.Health / otherHumanoid.MaxHealth * 100)
                                        local health_color = health_per >= 75 and self.Config.HealthBarColor1 or
                                                             health_per >= 50 and self.Config.HealthBarColor2 or
                                                             self.Config.HealthBarColor3
                                        
                                        -- Text số máu
                                        if self.State.HealthTextEnabled then
                                            local textY = barY + height * (1 - health_per / 100)
                                            if textY < barY then textY = barY end
                                            if textY > barY + height - 10 then textY = barY + height - 10 end
                                            
                                            boxDrawings.HealthText.Position = UDim2.new(0, barX - 20, 0, textY)
                                            boxDrawings.HealthText.Text = tostring(health_per)
                                            boxDrawings.HealthText.TextColor3 = health_color
                                            boxDrawings.HealthText.Visible = true
                                        else
                                            boxDrawings.HealthText.Visible = false
                                        end
                                        
                                        -- Thanh hiển thị máu
                                        if self.State.HealthBarEnabled then
                                            local health_bar_height = height * (health_per / 100)
                                            
                                            boxDrawings.HealthBar.Size = UDim2.new(0, 4, 0, health_bar_height)
                                            boxDrawings.HealthBar.Position = UDim2.new(0, barX, 0, barY + height - health_bar_height)
                                            boxDrawings.HealthBar.Visible = true
                                            
                                            boxDrawings.HealthBarBackground.Size = UDim2.new(0, 4, 0, height)
                                            boxDrawings.HealthBarBackground.Position = UDim2.new(0, barX, 0, barY)
                                            boxDrawings.HealthBarBackground.Visible = true
                                            
                                            boxDrawings.HealthBarOutline.Enabled = true
                                        else
                                            boxDrawings.HealthBar.Visible = false
                                            boxDrawings.HealthBarBackground.Visible = false
                                            boxDrawings.HealthBarOutline.Enabled = false
                                        end
                                    end
                                    
                                    -- 5. Xử lý Giáp (Armor Bar)
                                    if self.State.ArmorBarEnabled or self.State.HealthTextEnabled then -- Note: Check logic HealthText ở đây có vẻ thừa, nhưng giữ nguyên theo code gốc
                                        local bodyEffects = otherCharacter:FindFirstChild("BodyEffects")
                                        local armor = bodyEffects and bodyEffects:FindFirstChild("Armor") and bodyEffects.Armor.Value or 0
                                        local armor_per = math.floor(armor / 130 * 100) -- Giả sử max armor là 130
                                        
                                        local armor_color = armor_per >= 75 and self.Config.ArmorBarColor1 or
                                                            armor_per >= 50 and self.Config.ArmorBarColor2 or
                                                            self.Config.ArmorBarColor3
                                        
                                        local armor_bar_x = barX - 8  -- Lùi tiếp sang trái so với healthbar
                                        
                                        -- Text số giáp
                                        if self.State.HealthTextEnabled then -- Code gốc dùng chung state HealthTextEnabled cho giáp?
                                            local textY = barY + height * (1 - armor_per / 100)
                                            if textY < barY then textY = barY end
                                            if textY > barY + height - 10 then textY = barY + height - 10 end
                                            
                                            boxDrawings.ArmorText.Position = UDim2.new(0, armor_bar_x - 20, 0, textY)
                                            boxDrawings.ArmorText.Text = tostring(armor_per)
                                            boxDrawings.ArmorText.TextColor3 = armor_color
                                            boxDrawings.ArmorText.Visible = true
                                        else
                                            boxDrawings.ArmorText.Visible = false
                                        end
                                        
                                        -- Thanh hiển thị giáp
                                        if self.State.ArmorBarEnabled then
                                            local armor_bar_height = height * (armor_per / 100)
                                            
                                            boxDrawings.ArmorBar.Size = UDim2.new(0, 4, 0, armor_bar_height)
                                            boxDrawings.ArmorBar.Position = UDim2.new(0, armor_bar_x, 0, barY + height - armor_bar_height)
                                            boxDrawings.ArmorBar.Visible = true
                                            
                                            boxDrawings.ArmorBarBackground.Size = UDim2.new(0, 4, 0, height)
                                            boxDrawings.ArmorBarBackground.Position = UDim2.new(0, armor_bar_x, 0, barY)
                                            boxDrawings.ArmorBarBackground.Visible = true
                                            
                                            boxDrawings.ArmorBarOutline.Enabled = true
                                        else
                                            boxDrawings.ArmorBar.Visible = false
                                            boxDrawings.ArmorBarBackground.Visible = false
                                            boxDrawings.ArmorBarOutline.Enabled = false
                                        end
                                    end

                                else
                                    -- Player không nằm trong màn hình (OnScreen = false)
                                    self:HideBox(otherPlayer)
                                end
                            else
                                -- Khoảng cách quá xa
                                self:ClearBox(otherPlayer)
                            end
                        else
                            -- Máu <= 0 (Đã chết)
                            self:ClearBox(otherPlayer)
                        end
                    else
                        -- Không tìm thấy Character/Humanoid
                        self:ClearBox(otherPlayer)
                    end
                end
                ::continue_loop:: -- Label cho goto nếu dùng
            end
        end
    else
        -- Tắt toàn bộ ESP
        for player, _ in pairs(self.Caches.BoxCache) do
            self:HideBox(player)
        end
    end
end
function espModule:UpdateSkeleton()
    if not self.State.SkeletonEnabled then
        for player, _ in pairs(self.Caches.SkeletonCache) do
            self:ClearSkeleton(player)
        end
        return
    end
    
    if not (localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")) then
        for player, _ in pairs(self.Caches.SkeletonCache) do
            self:ClearSkeleton(player)
        end
        return
    end
    
    local cameraPos = currentCamera.CFrame.Position
    
    for _, otherPlayer in ipairs(playersService:GetPlayers()) do
        if otherPlayer ~= localPlayer then
            local otherCharacter = otherPlayer.Character
            if otherCharacter and otherCharacter:FindFirstChild("HumanoidRootPart") and otherCharacter:FindFirstChild("Humanoid") then
                local otherHumanoid = otherCharacter.Humanoid
                if otherHumanoid.Health > 0 then
                    local otherRoot = otherCharacter.HumanoidRootPart
                    local distance = getCameraDistance(otherRoot.Position)
                    if distance <= self.Config.ESPDistance then
                        if self.Config.TeamCheck and localPlayer.Team and otherPlayer.Team == localPlayer.Team then
                            self:ClearSkeleton(otherPlayer)
                            return
                        end
                        if not self.Caches.SkeletonCache[otherPlayer] then
                            self.Caches.SkeletonCache[otherPlayer] = self:CreateSkeleton(otherPlayer)
                        end
                        local skeletonLines = self.Caches.SkeletonCache[otherPlayer]
                        local isR6 = otherCharacter:FindFirstChild("Torso") and not otherCharacter:FindFirstChild("UpperTorso")
                        
                        local function getScreenPos(partName)
                            local part = otherCharacter:FindFirstChild(partName)
                            if part then
                                local screenPos, onScreen = currentCamera:WorldToViewportPoint(part.Position)
                                return Vector2.new(screenPos.X, screenPos.Y), onScreen
                            end
                            return Vector2.new(0, 0), false
                        end
                        
                        local allOnScreen = true
                        
                        if isR6 then
                            local headPos, headOn = getScreenPos("Head")
                            local torsoPos, torsoOn = getScreenPos("Torso")
                            local leftArmPos, leftArmOn = getScreenPos("Left Arm")
                            local rightArmPos, rightArmOn = getScreenPos("Right Arm")
                            local leftLegPos, leftLegOn = getScreenPos("Left Leg")
                            local rightLegPos, rightLegOn = getScreenPos("Right Leg")
                            
                            allOnScreen = headOn and torsoOn and leftArmOn and rightArmOn and leftLegOn and rightLegOn
                            
                            skeletonLines.HeadToTorso.From = headPos
                            skeletonLines.HeadToTorso.To = torsoPos
                            skeletonLines.HeadToTorso.Visible = allOnScreen
                            
                            skeletonLines.TorsoToLeftArm.From = torsoPos
                            skeletonLines.TorsoToLeftArm.To = leftArmPos
                            skeletonLines.TorsoToLeftArm.Visible = allOnScreen
                            
                            skeletonLines.TorsoToRightArm.From = torsoPos
                            skeletonLines.TorsoToRightArm.To = rightArmPos
                            skeletonLines.TorsoToRightArm.Visible = allOnScreen
                            
                            skeletonLines.TorsoToLeftLeg.From = torsoPos
                            skeletonLines.TorsoToLeftLeg.To = leftLegPos
                            skeletonLines.TorsoToLeftLeg.Visible = allOnScreen
                            
                            skeletonLines.TorsoToRightLeg.From = torsoPos
                            skeletonLines.TorsoToRightLeg.To = rightLegPos
                            skeletonLines.TorsoToRightLeg.Visible = allOnScreen
                        else
                            local headPos, headOn = getScreenPos("Head")
                            local upperTorsoPos, upperTorsoOn = getScreenPos("UpperTorso")
                            local lowerTorsoPos, lowerTorsoOn = getScreenPos("LowerTorso")
                            local leftUpperArmPos, leftUpperArmOn = getScreenPos("LeftUpperArm")
                            local leftLowerArmPos, leftLowerArmOn = getScreenPos("LeftLowerArm")
                            local leftHandPos, leftHandOn = getScreenPos("LeftHand")
                            local rightUpperArmPos, rightUpperArmOn = getScreenPos("RightUpperArm")
                            local rightLowerArmPos, rightLowerArmOn = getScreenPos("RightLowerArm")
                            local rightHandPos, rightHandOn = getScreenPos("RightHand")
                            local leftUpperLegPos, leftUpperLegOn = getScreenPos("LeftUpperLeg")
                            local leftLowerLegPos, leftLowerLegOn = getScreenPos("LeftLowerLeg")
                            local leftFootPos, leftFootOn = getScreenPos("LeftFoot")
                            local rightUpperLegPos, rightUpperLegOn = getScreenPos("RightUpperLeg")
                            local rightLowerLegPos, rightLowerLegOn = getScreenPos("RightLowerLeg")
                            local rightFootPos, rightFootOn = getScreenPos("RightFoot")
                            
                            allOnScreen = headOn and upperTorsoOn and lowerTorsoOn and leftUpperArmOn and leftLowerArmOn and leftHandOn and rightUpperArmOn and rightLowerArmOn and rightHandOn and leftUpperLegOn and leftLowerLegOn and leftFootOn and rightUpperLegOn and rightLowerLegOn and rightFootOn
                            
                            skeletonLines.HeadToUpperTorso.From = headPos
                            skeletonLines.HeadToUpperTorso.To = upperTorsoPos
                            skeletonLines.HeadToUpperTorso.Visible = allOnScreen
                            
                            skeletonLines.UpperTorsoToLowerTorso.From = upperTorsoPos
                            skeletonLines.UpperTorsoToLowerTorso.To = lowerTorsoPos
                            skeletonLines.UpperTorsoToLowerTorso.Visible = allOnScreen
                            
                            skeletonLines.UpperTorsoToLeftUpperArm.From = upperTorsoPos
                            skeletonLines.UpperTorsoToLeftUpperArm.To = leftUpperArmPos
                            skeletonLines.UpperTorsoToLeftUpperArm.Visible = allOnScreen
                            
                            skeletonLines.LeftUpperArmToLeftLowerArm.From = leftUpperArmPos
                            skeletonLines.LeftUpperArmToLeftLowerArm.To = leftLowerArmPos
                            skeletonLines.LeftUpperArmToLeftLowerArm.Visible = allOnScreen
                            
                            skeletonLines.LeftLowerArmToLeftHand.From = leftLowerArmPos
                            skeletonLines.LeftLowerArmToLeftHand.To = leftHandPos
                            skeletonLines.LeftLowerArmToLeftHand.Visible = allOnScreen
                            
                            skeletonLines.UpperTorsoToRightUpperArm.From = upperTorsoPos
                            skeletonLines.UpperTorsoToRightUpperArm.To = rightUpperArmPos
                            skeletonLines.UpperTorsoToRightUpperArm.Visible = allOnScreen
                            
                            skeletonLines.RightUpperArmToRightLowerArm.From = rightUpperArmPos
                            skeletonLines.RightUpperArmToRightLowerArm.To = rightLowerArmPos
                            skeletonLines.RightUpperArmToRightLowerArm.Visible = allOnScreen
                            
                            skeletonLines.RightLowerArmToRightHand.From = rightLowerArmPos
                            skeletonLines.RightLowerArmToRightHand.To = rightHandPos
                            skeletonLines.RightLowerArmToRightHand.Visible = allOnScreen
                            
                            skeletonLines.LowerTorsoToLeftUpperLeg.From = lowerTorsoPos
                            skeletonLines.LowerTorsoToLeftUpperLeg.To = leftUpperLegPos
                            skeletonLines.LowerTorsoToLeftUpperLeg.Visible = allOnScreen
                            
                            skeletonLines.LeftUpperLegToLeftLowerLeg.From = leftUpperLegPos
                            skeletonLines.LeftUpperLegToLeftLowerLeg.To = leftLowerLegPos
                            skeletonLines.LeftUpperLegToLeftLowerLeg.Visible = allOnScreen
                            
                            skeletonLines.LeftLowerLegToLeftFoot.From = leftLowerLegPos
                            skeletonLines.LeftLowerLegToLeftFoot.To = leftFootPos
                            skeletonLines.LeftLowerLegToLeftFoot.Visible = allOnScreen
                            
                            skeletonLines.LowerTorsoToRightUpperLeg.From = lowerTorsoPos
                            skeletonLines.LowerTorsoToRightUpperLeg.To = rightUpperLegPos
                            skeletonLines.LowerTorsoToRightUpperLeg.Visible = allOnScreen
                            
                            skeletonLines.RightUpperLegToRightLowerLeg.From = rightUpperLegPos
                            skeletonLines.RightUpperLegToRightLowerLeg.To = rightLowerLegPos
                            skeletonLines.RightUpperLegToRightLowerLeg.Visible = allOnScreen
                            
                            skeletonLines.RightLowerLegToRightFoot.From = rightLowerLegPos
                            skeletonLines.RightLowerLegToRightFoot.To = rightFootPos
                            skeletonLines.RightLowerLegToRightFoot.Visible = allOnScreen
                        end
                        
                        if not allOnScreen then
                            for _, line in pairs(skeletonLines) do
                                line.Visible = false
                            end
                        end
                    else
                        self:ClearSkeleton(otherPlayer)
                    end
                else
                    self:ClearSkeleton(otherPlayer)
                end
            else
                self:ClearSkeleton(otherPlayer)
            end
        end
    end
end

function espModule:UpdateTracer()
    if not self.State.TracerEnabled then
        for player, _ in pairs(self.Caches.TracerCache) do
            self:ClearTracer(player)
        end
        return
    end
    
    if not (localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")) then
        for player, _ in pairs(self.Caches.TracerCache) do
            self:ClearTracer(player)
        end
        return
    end
    
    local cameraPos = currentCamera.CFrame.Position
    local viewportSize = currentCamera.ViewportSize
    local originPos
    
    if self.Config.TracerOrigin == "Bottom Screen" then
        originPos = Vector2.new(viewportSize.X / 2, viewportSize.Y)
    elseif self.Config.TracerOrigin == "Cursor" then
        originPos = userInputService:GetMouseLocation()
    elseif self.Config.TracerOrigin == "Top Screen" then
        originPos = Vector2.new(viewportSize.X / 2, 0)
    end
    
    for _, otherPlayer in ipairs(playersService:GetPlayers()) do
        if otherPlayer ~= localPlayer then
            local otherCharacter = otherPlayer.Character
            if otherCharacter and otherCharacter:FindFirstChild("HumanoidRootPart") and otherCharacter:FindFirstChild("Humanoid") then
                local otherHumanoid = otherCharacter.Humanoid
                if otherHumanoid.Health > 0 then
                    local tracerTarget = otherCharacter:FindFirstChild("Head") or otherCharacter.HumanoidRootPart
                    local distance = getCameraDistance(tracerTarget.Position)
                    if distance <= self.Config.ESPDistance then
                        if self.Config.TeamCheck and localPlayer.Team and otherPlayer.Team == localPlayer.Team then
                            self:ClearTracer(otherPlayer)
                            return
                        end
                        if not self.Caches.TracerCache[otherPlayer] then
                            self.Caches.TracerCache[otherPlayer] = self:CreateTracer(otherPlayer)
                        end
                        local tracerLine = self.Caches.TracerCache[otherPlayer]
                        local targetScreenPos, targetOnScreen = currentCamera:WorldToViewportPoint(tracerTarget.Position)
                        tracerLine.From = originPos
                        tracerLine.To = Vector2.new(targetScreenPos.X, targetScreenPos.Y)
                        tracerLine.Visible = targetOnScreen
                    else
                        self:ClearTracer(otherPlayer)
                    end
                else
                    self:ClearTracer(otherPlayer)
                end
            else
                self:ClearTracer(otherPlayer)
            end
        end
    end
end

function espModule:UpdateChams()
    if not self.State.ChamsEnabled then
        for player, _ in pairs(self.Caches.ChamsCache) do
            self:ClearChams(player)
        end
        return
    end
    
    if not (localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")) then
        for player, _ in pairs(self.Caches.ChamsCache) do
            self:ClearChams(player)
        end
        return
    end
    
    local cameraPos = currentCamera.CFrame.Position
    
    for _, otherPlayer in ipairs(playersService:GetPlayers()) do
        if otherPlayer ~= localPlayer then
            local otherCharacter = otherPlayer.Character
            if otherCharacter and otherCharacter:FindFirstChild("HumanoidRootPart") and otherCharacter:FindFirstChild("Humanoid") then
                local otherHumanoid = otherCharacter.Humanoid
                if otherHumanoid.Health > 0 then
                    local otherRoot = otherCharacter.HumanoidRootPart
                    local distance = getCameraDistance(otherRoot.Position)
                    if distance <= self.Config.ESPDistance then
                        if self.Config.TeamCheck and localPlayer.Team and otherPlayer.Team == localPlayer.Team then
                            self:ClearChams(otherPlayer)
                            return
                        end
                        if not self.Caches.ChamsCache[otherPlayer] then
                            self.Caches.ChamsCache[otherPlayer] = self:CreateChams(otherPlayer)
                        end
                    else
                        self:ClearChams(otherPlayer)
                    end
                else
                    self:ClearChams(otherPlayer)
                end
            else
                self:ClearChams(otherPlayer)
            end
        end
    end
end

function espModule:UpdateRing()
    if not self.State.RingEnabled then
        for player, _ in pairs(self.Caches.RingCache) do
            self:ClearRing(player)
        end
        return
    end
    
    if not (localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")) then
        for player, _ in pairs(self.Caches.RingCache) do
            self:ClearRing(player)
        end
        return
    end
    
    for _, otherPlayer in ipairs(playersService:GetPlayers()) do
        if otherPlayer ~= localPlayer then
            local otherCharacter = otherPlayer.Character
            if otherCharacter and otherCharacter:FindFirstChild("HumanoidRootPart") and otherCharacter:FindFirstChild("Humanoid") then
                local otherHumanoid = otherCharacter.Humanoid
                if otherHumanoid.Health > 0 then
                    local otherRoot = otherCharacter.HumanoidRootPart
                    local distance = getCameraDistance(otherRoot.Position)
                    if distance <= self.Config.ESPDistance then
                        if self.Config.TeamCheck and localPlayer.Team and otherPlayer.Team == localPlayer.Team then
                            self:ClearRing(otherPlayer)
                            return
                        end
                        if not self.Caches.RingCache[otherPlayer] then
                            self.Caches.RingCache[otherPlayer] = self:CreateRing(otherPlayer)
                        end
                        local data = self.Caches.RingCache[otherPlayer]
                        data.Root = otherRoot
                        data.Ring.Visible = true
                    else
                        if self.Caches.RingCache[otherPlayer] then
                            self.Caches.RingCache[otherPlayer].Ring.Visible = false
                        end
                    end
                else
                    self:ClearRing(otherPlayer)
                end
            else
                self:ClearRing(otherPlayer)
            end
        end
    end
end

function espModule:UpdateAnimations(dt)
    local t = tick()
    currentRotation = (currentRotation - self.Config.RotateSpeed * dt) % 360
    for _, boxDrawings in pairs(self.Caches.BoxCache) do
        if self.Config.BoxGradientEnabled then
            boxDrawings.Gradient.Rotation = currentRotation
        end
        boxDrawings.CurrentHealth = lerpNumber(boxDrawings.CurrentHealth, boxDrawings.TargetHealth, self.Config.HealthBarLerpSpeed)
    end
    for _, data in pairs(self.Caches.RingCache) do
        if data.Root and data.Ring.Visible then
            local yOffset = math.sin(t * self.Config.ScanSpeed) * self.Config.ScanHeight
            data.Holder.CFrame = data.Root.CFrame * CFrame.new(0, yOffset, 0)
            data.Ring.Transparency = 0.2 + (math.abs(math.sin(t * self.Config.ScanSpeed)) * 0.4)
        end
    end
end

function espModule:InitiateBox(color)
    self.Config.BoxColor = color or self.Config.BoxColor
    self.State.BoxEnabled = true
end

function espModule:InitiateName(value)
    self.State.NameEnabled = value
end

function espModule:InitiateDistance(value)
    self.State.DistanceEnabled = value
end

function espModule:InitiateSkeleton(color)
    self.Config.SkeletonColor = color or self.Config.SkeletonColor
    self.State.SkeletonEnabled = true
end

function espModule:InitiateHealthText(value)
    self.State.HealthTextEnabled = value
end

function espModule:InitiateHealthBar(value)
    self.State.HealthBarEnabled = value
end

function espModule:InitiateTracer(color, origin)
    self.Config.TracerColor = color or self.Config.TracerColor
    self.Config.TracerOrigin = origin or self.Config.TracerOrigin
    self.State.TracerEnabled = true
end

function espModule:InitiateChams(color)
    self.Config.ChamsColor = color or self.Config.ChamsColor
    self.State.ChamsEnabled = true
end

function espModule:InitiateRing(color)
    self.Config.RingColor = color or self.Config.RingColor
    self.State.RingEnabled = true
end

function espModule:TeamCheck(value)
    self.Config.TeamCheck = value
end

function espModule:SetDistance(value)
    self.Config.ESPDistance = value
end

function espModule:Cleanup()
    for player, _ in pairs(self.Caches.BoxCache) do
        self:ClearBox(player)
    end
    for player, _ in pairs(self.Caches.SkeletonCache) do
        self:ClearSkeleton(player)
    end
    for player, _ in pairs(self.Caches.TracerCache) do
        self:ClearTracer(player)
    end
    for player, _ in pairs(self.Caches.ChamsCache) do
        self:ClearChams(player)
    end
    for player, _ in pairs(self.Caches.RingCache) do
        self:ClearRing(player)
    end
end

function espModule:Destroy()
    self:Cleanup()
    if heartbeatConnection then
        heartbeatConnection:Disconnect()
    end
    if renderConnection then
        renderConnection:Disconnect()
    end
    if self.EspGui then
        self.EspGui:Destroy()
    end
    self.State.BoxEnabled = false
    self.State.NameEnabled = false
    self.State.DistanceEnabled = false
    self.State.SkeletonEnabled = false
    self.State.HealthTextEnabled = false
    self.State.HealthBarEnabled = false
    self.State.TracerEnabled = false
    self.State.ChamsEnabled = false
    self.State.RingEnabled = false
end

function espModule:Initialize()
    self.EspGui = Instance.new("ScreenGui")
    self.EspGui.Name = "MatchaEspGui"
    self.EspGui.Parent = localPlayer.PlayerGui
    self.EspGui.IgnoreGuiInset = true
    self.EspGui.ResetOnSpawn = false
    
    playersService.PlayerRemoving:Connect(function(removedPlayer)
        safeCall(function()
            self:ClearBox(removedPlayer)
            self:ClearSkeleton(removedPlayer)
            self:ClearTracer(removedPlayer)
            self:ClearChams(removedPlayer)
            self:ClearRing(removedPlayer)
        end)
    end)
    
    playersService.PlayerAdded:Connect(function(addedPlayer)
        addedPlayer.CharacterAdded:Connect(function(newCharacter)
            newCharacter.AncestryChanged:Connect(function()
                if not newCharacter:IsDescendantOf(workspaceService) then
                    safeCall(function()
                        self:ClearBox(addedPlayer)
                        self:ClearSkeleton(addedPlayer)
                        self:ClearTracer(addedPlayer)
                        self:ClearChams(addedPlayer)
                        self:ClearRing(addedPlayer)
                    end)
                end
            end)
            
            local humanoid = newCharacter:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.Died:Connect(function()
                    safeCall(function()
                        self:ClearBox(addedPlayer)
                        self:ClearSkeleton(addedPlayer)
                        self:ClearTracer(addedPlayer)
                        self:ClearChams(addedPlayer)
                        self:ClearRing(addedPlayer)
                    end)
                end)
            end
        end)
    end)
    
    heartbeatConnection = runService.Heartbeat:Connect(function()
        if os.clock() % updateInterval < 0.1 then
            safeCall(function()
                self:Cleanup()
            end)
        end
    end)
    
    renderConnection = runService.RenderStepped:Connect(function(dt)
        safeCall(function()
            self:UpdateBox()
            self:UpdateSkeleton()
            self:UpdateTracer()
            self:UpdateChams()
            self:UpdateRing()
            self:UpdateAnimations(dt)
        end)
    end)
end

return espModule
